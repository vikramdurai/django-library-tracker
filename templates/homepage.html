{% extends 'base.html' %}
{% load static %}
{% load book_extras %}
{% block content %}
<form action="{% url 'search' %}" method="POST">
    {% csrf_token %}
    <div class="ui input">{{ form }}<button class="ui button red" style="margin-left: 0.5em;" type="submit">Go</button>
    </div>
</form>
<h3>Recent books</h3>
<div class="ui stackable four column grid">
    {% for book in r_books %}
    <div class="column">
        <div class="ui fluid card">
            <div class="content">
                <div class="left floated meta">Author: {{ book.publication.author }}</div>
                <span class="right floated meta">
                    {% if book.available_goodreads %}
                    Available on goodreads
                    {% endif %}
                </span>
            </div>
            <div class="image">
                {% get_book_url book.publication.slug as book_url %}
                <img class="book_image" src="{% static book_url %}" style="width:19em;height:15em;">
            </div>
            <div class=" content">
                <div class="header">
                    {{ book.publication.title }}
                </div>
                <div class="meta">
                    Added on {{ book.date_added }}
                </div>
                <div class="description">
                    Accession number: <strong>{{ book.acc }}</strong> <br>
                    Genre: <strong>{{ book.publication.genre }}</strong> <br>
                    Library: <strong>{{ book.library }}</strong> <br>
                </div>
            </div>
            <script>
                // stolen from stackoverflow
                // https://stackoverflow.com/questions/18837735/check-if-image-exists-on-server-using-javascript
                function imageExists(image_url) {

                    var http = new XMLHttpRequest();

                    http.open('HEAD', image_url, false);
                    http.send();

                    return http.status != 404;

                }
                if (!imageExists("{% static book_url %}")) {
                    $(".book_image").attr("src", "http://dynamicmediainstitute.org/wp-content/themes/dynamic-media-institute/imagery/default-book.png")
                }
            </script>
        </div>
    </div>
    {% endfor %}
</div><br>
<h2>My borrowed books</h2>
{% if borrowed_entries %}
<table class="ui celled table">
    <thead>
        <tr>
            <th>Title</th>
            <th>ACC #</th>
            <th>Date borrowed</th>
            <th>Date to return</th>
        </tr>
    </thead>
    <tbody>
        {% for i in borrowed_entries %}
        <tr>
            <td><a href="{% url 'titles' i.book.publication.slug i.book.acc %}">{{ i.book.publication.title }}</a></td>
            <td>{{ i.book.acc }}</td>
            <td>{{ i.date }}</td>
            <td>

                {{ i.most_recent_extendlog.new_returndate }} <a
                    href="{% url 'extend' i.book.publication.slug i.book.acc %}">Extend</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No borrowed books.</p>
{% endif %}
{% if user_libraries %}
<h2>Libraries I belong to</h2>
{% for lb in user_libraries %}
<ul>
    <li>{{ lb }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endblock %}